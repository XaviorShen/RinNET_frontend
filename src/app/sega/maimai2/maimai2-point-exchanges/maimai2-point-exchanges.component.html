<div class="container-fluid mt-3">
  <!-- 标题和筛选区域 -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card bg-dark border-secondary">
        <div
          class="card-header bg-dark text-light border-secondary d-flex justify-content-between align-items-center"
        >
          <h4 class="mb-0">任务点数兑换 - 舞萌DX</h4>
          <button
            type="button"
            class="btn btn-sm btn-outline-danger btn-outline-secondary"
            (click)="closeModal()"
          >
            <i class="bi bi-x-lg"></i> 关闭
          </button>
        </div>
        <div class="card-body">
          <!-- 分类筛选ComboBox -->
          <div class="row align-items-end">
            <div class="col-md-6">
              <label class="form-label text-light fw-bold">物品类型筛选</label>
              <select
                class="form-select bg-dark text-light border-secondary"
                [(ngModel)]="filterItemType"
                (change)="loadExchangeItemDataList(0)"
              >
                <option [ngValue]="null">全部类型</option>
                <option
                  *ngFor="let type of exchangeItemTypes"
                  [ngValue]="type.value"
                >
                  {{ getExchangeItemTypeName(type) }}
                </option>
              </select>
            </div>
            <div class="col-md-6 text-end text-light">
              <span class="me-3"
                >我的可用任务点数:
                <span>{{ userPointData.availablePoints }}</span></span
              >
            </div>
          </div>
          <!-- 第二行：文本搜索和筛选按钮 -->
          <div class="row align-items-end mt-2">
            <div class="col-md-8">
              <label class="form-label text-light fw-bold"
                >物品名称/描述搜索</label
              >
              <div class="input-group">
                <span
                  class="input-group-text bg-dark text-light border-secondary"
                >
                  <i class="bi bi-search"></i>
                </span>
                <input
                  type="text"
                  class="form-control bg-dark text-light border-secondary"
                  placeholder="输入物品名称或描述关键字..."
                  [(ngModel)]="searchKeyword"
                  (keyup.enter)="loadExchangeItemDataList(0)"
                />
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check form-switch hide-completed-toggle">
                <input
                  class="form-check-input"
                  type="checkbox"
                  role="switch"
                  id="onlyEnable"
                  [(ngModel)]="onlyEnable"
                />
                <label class="form-check-label" for="onlyEnable">
                  只显示允许兑换的
                </label>
              </div>
              <button
                class="btn btn-outline-primary w-50"
                (click)="loadExchangeItemDataList(0)"
              >
                <i class="bi bi-filter"></i> 应用筛选
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4 mb-3"
  >
    <div
      *ngFor="let item of filterExchangeInfoList"
      class="col"
      [ngClass]="getCardSizeClass(item.itemType)"
    >
      <div class="card h-100 bg-dark text-light border-secondary exchange-card">
        <!-- 图片区域 -->
        <div
          class="card-img-top d-flex justify-content-center align-items-center p-3 bg-dark"
          style="min-height: 120px; height: 140px"
        >
          <img
            *ngIf="enableImages && getImageUrl(item)"
            [src]="getImageUrl(item)"
            class="img-fluid exchange-item-img"
            style="
              max-width: 100%;
              max-height: 100%;
              width: auto;
              height: auto;
              object-fit: contain;
            "
            alt="{{ item.name }}"
          />
          <div
            *ngIf="!enableImages || !getImageUrl(item)"
            class="placeholder-image d-flex justify-content-center align-items-center"
            style="max-width: 100%; max-height: 100%; width: 80px; height: 80px"
          >
            <i class="bi bi-box-seam fs-1 text-secondary"></i>
          </div>
        </div>

        <!-- 物品信息 -->
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title text-truncate mb-0" [title]="item.name">
              {{ item.name }}
            </h5>
            <span
              class="badge"
              [ngClass]="getItemTypeBadgeClass(item.itemType)"
            >
              {{ getExchangeItemTypeNameByValue(item.itemType) }}
            </span>
          </div>

          <p
            class="card-text small text-secondary-emphasis text-truncate-2 mb-2"
            [title]="item.description"
          >
            {{ item.description || "暂无描述" }}
          </p>

          <div class="item-details small">
            <div class="d-flex justify-content-between mb-1">
              <span>兑换获得:</span>
              <span class="fw-bold">{{ item.itemCount }} 个</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>所需点数:</span>
              <span class="fw-bold text-warning">{{ item.costPoints }} 点</span>
            </div>
            <div
              class="d-flex justify-content-between mb-1"
              *ngIf="item.limitCount >= 0"
            >
              <span>个人已换:</span>
              <span class="fw-bold"
                >{{ getUserExchangedCount(item.id) }} /
                {{ item.limitCount === -1 ? "∞" : item.limitCount }}</span
              >
            </div>
          </div>
        </div>

        <!-- 卡片底部 - 兑换按钮 -->
        <div class="card-footer bg-transparent border-secondary">
          <button
            *ngIf="canUserExchange(item)"
            class="btn btn-outline-success w-100 fw-bold"
            (click)="openExchangeModal(item)"
          >
            兑换
          </button>
          <button
            *ngIf="!canUserExchange(item)"
            class="btn btn-secondary w-100"
            disabled
          >
            <i class="bi bi-lock-fill me-2"></i
            >{{ getCannotExchangeReason(item) }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 空状态显示 -->
  <div *ngIf="filterExchangeInfoList.length === 0" class="row mt-5">
    <div class="col-12 text-center text-light py-5">
      <i class="bi bi-inbox fs-1 d-block mb-3"></i>
      <h5>暂无兑换物品</h5>
      <p class="text-secondary">当前筛选条件下没有可兑换的物品</p>
    </div>
  </div>

  <!-- 分页控件 -->
  <div *ngIf="filterExchangeInfoListTotalCount > pageSize" class="row mt-4">
    <div class="col-12">
      <nav aria-label="兑换物品分页">
        <ul class="pagination justify-content-center">
          <li
            class="page-item"
            [class.disabled]="filterExchangeInfoListPage === 0"
          >
            <a
              class="page-link bg-dark text-light border-secondary"
              (click)="loadExchangeItemDataList(filterExchangeInfoListPage - 1)"
              href="javascript:void(0)"
            >
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          <li
            *ngFor="let page of getPageNumbers()"
            class="page-item"
            [class.active]="page === filterExchangeInfoListPage"
          >
            <a
              class="page-link"
              [ngClass]="{
                'bg-primary text-white': page === filterExchangeInfoListPage,
                'bg-dark text-light border-secondary':
                  page !== filterExchangeInfoListPage,
              }"
              (click)="loadExchangeItemDataList(page)"
              href="javascript:void(0)"
            >
              {{ page + 1 }}
            </a>
          </li>

          <li
            class="page-item"
            [class.disabled]="filterExchangeInfoListPage >= getMaxPage()"
          >
            <a
              class="page-link bg-dark text-light border-secondary"
              (click)="loadExchangeItemDataList(filterExchangeInfoListPage + 1)"
              href="javascript:void(0)"
            >
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<ng-template #exchangeModal let-modal>
  <div class="modal-header bg-dark text-light border-secondary">
    <h5 class="modal-title">确认兑换</h5>
    <button
      type="button"
      class="btn-close btn-close-white"
      aria-label="Close"
      (click)="modal.dismiss()"
    ></button>
  </div>
  <div class="modal-body bg-dark text-light">
    <div *ngIf="selectedExchangeItem" class="exchange-confirm">
      <div class="d-flex align-items-center mb-4">
        <div class="flex-shrink-0 me-3">
          <div
            class="placeholder-image d-flex justify-content-center align-items-center bg-dark border-secondary rounded"
          >
            <i class="bi bi-box-seam fs-2 text-secondary"></i>
          </div>
        </div>
        <div class="flex-grow-1">
          <h5 class="mb-1">{{ selectedExchangeItem.name }}</h5>
          <p class="small text-secondary mb-0">
            <span
              *ngFor="
                let line of selectedExchangeItem.description.split('\n');
                let last = last
              "
            >
              {{ line }}<br *ngIf="!last" />
            </span>
          </p>
        </div>
      </div>

      <div
        class="info-row d-flex justify-content-between mb-2 p-2 bg-dark border-secondary rounded"
      >
        <span>兑换数量:</span>
        <span class="fw-bold">{{ selectedExchangeItem.itemCount }} 个</span>
      </div>
      <div
        class="info-row d-flex justify-content-between mb-2 p-2 bg-dark border-secondary rounded"
      >
        <span>需要点数:</span>
        <span class="fw-bold text-warning"
          >{{ selectedExchangeItem.costPoints }} 点</span
        >
      </div>
      <div
        *ngIf="selectedExchangeItem.stockCount >= 0"
        class="info-row d-flex justify-content-between mb-2 p-2 bg-dark border-secondary rounded"
      >
        <span>库存:</span>
        <span class="fw-bold"
          >{{ selectedExchangeItem.exchangedCount }} /
          {{ selectedExchangeItem.stockCount }}</span
        >
      </div>
      <div
        class="info-row d-flex justify-content-between p-2 bg-dark border-secondary rounded"
      >
        <span>兑换后剩余:</span>
        <span class="fw-bold text-danger"
          >{{
            userPointData.availablePoints - selectedExchangeItem.costPoints
          }}
          点</span
        >
      </div>

      <div class="alert alert-warning mt-3 mb-0" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        确认使用 {{ selectedExchangeItem.costPoints }} 任务点数兑换此物品吗？
      </div>
    </div>
  </div>
  <div class="modal-footer bg-dark border-secondary">
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="modal.dismiss()"
    >
      取消
    </button>
    <button
      type="button"
      *ngIf="canUserExchange(selectedExchangeItem)"
      class="btn btn-success"
      (click)="confirmExchange(modal)"
    >
      确认兑换
    </button>
  </div>
</ng-template>
